<!DOCTYPE html> 
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="theme-color" content="#0a0a0c">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>SereneTrack - Suivi d'Exposition</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            brand: {
              orange: '#e67e22',
              hover: '#d35400',
              light: '#fff0e6'
            }
          }
        }
      }
    }
  </script>

  <style>
    body { background-color: #f9fafb; overscroll-behavior-y: contain; }
    .screen { display: none; height: 100%; flex-direction: column; }
    .screen.active { display: flex; animation: fadeIn 0.3s ease-in-out; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Chrono XL et Lisible */
    #timer-display { font-size: 2.5rem; line-height: 1; font-weight: 800; color: #e67e22; }

    /* Mini-courbes dans l'Historique */
    .sparkline-canvas { width: 80px !important; height: 40px !important; }

    /* MODE IMPRESSION pour PDF */
    @media print {
      body { background: white; }
      .no-print { display: none !important; }
      #screen-result { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
      .screen:not(#screen-result) { display: none !important; }
      main { box-shadow: none; max-width: 100%; height: auto; border: none; }
      canvas { max-width: 100% !important; height: auto !important; }
    }

    #toast {
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      transform: translateY(-20px) translateX(-50%);
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
      transform: translateY(0) translateX(-50%);
    }
  </style>
</head>

<body class="text-gray-800 h-screen w-screen flex flex-col md:items-center md:justify-center md:bg-gray-100">

  <main class="w-full md:max-w-[500px] bg-white h-full md:h-[800px] md:rounded-3xl md:shadow-2xl overflow-hidden flex flex-col relative border-x border-gray-100">

    <header class="bg-white border-b border-gray-100 p-4 flex justify-between items-center z-10 shrink-0 no-print">
      <div>
        <h1 class="text-xl font-bold text-gray-900 tracking-tight">SereneTrack</h1>
        <p class="text-xs text-gray-500">Thérapie TCC</p>
      </div>
      <div class="flex items-center space-x-2 bg-orange-50 px-3 py-2 rounded-2xl">
        <div id="status-indicator" class="h-3 w-3 rounded-full bg-gray-300"></div>
        <div id="timer-display">00:00</div>
      </div>
    </header>

    <div class="flex-grow relative overflow-y-auto p-4 md:p-6" id="app-container">

      <div id="screen-home" class="screen active justify-center items-center text-center space-y-8 no-print">
        <div class="w-24 h-24 bg-orange-50 rounded-full flex items-center justify-center mb-2 animate-pulse">
          <i data-lucide="play" class="w-10 h-10 text-brand-orange ml-1"></i>
        </div>
        <div>
          <h2 class="text-2xl font-bold mb-2">Prêt pour l'exposition ?</h2>
          <p class="text-gray-500 text-sm max-w-[280px] mx-auto">L'écran restera allumé pour faciliter l'enregistrement de votre état.</p>
        </div>
        <div class="w-full max-w-xs space-y-3">
          <button onclick="app.goToPreSession()" class="w-full py-4 bg-brand-orange text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform">
            Nouvelle Séance
          </button>
          <button onclick="app.goToHistory()" class="w-full py-4 bg-white border border-gray-200 text-gray-600 rounded-2xl font-medium flex items-center justify-center">
            <i data-lucide="history" class="w-4 h-4 mr-2"></i> Voir mes progrès
          </button>
        </div>
      </div>

      <div id="screen-pre" class="screen no-print">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-lg font-bold">Décrivez la situation</h2>
          <button onclick="app.goToHome()" class="p-2 text-gray-400"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <textarea id="input-situation" placeholder="Ex: Commander un café seul en terrasse..." class="w-full p-4 border border-gray-300 rounded-xl min-h-[150px] text-lg mb-4 focus:ring-2 focus:ring-brand-orange focus:border-transparent outline-none"></textarea>
        <button id="btn-start" onclick="app.startSession()" disabled class="mt-auto w-full py-4 rounded-xl font-bold text-lg bg-gray-200 text-gray-400 cursor-not-allowed">
          Démarrer
        </button>
      </div>

      <div id="screen-running" class="screen no-print">
        <p id="lbl-situation" class="text-center text-sm text-gray-400 font-medium mb-8 truncate italic px-4"></p>
        <div class="flex items-center justify-center mb-6 h-12">
          <div id="prompt-badge" class="hidden bg-brand-orange text-white px-6 py-2 rounded-full text-sm font-bold animate-bounce">
            <span id="prompt-text">Enregistrez votre état</span>
          </div>
          <p id="wait-text" class="text-gray-300 text-xs">Analyse en cours...</p>
        </div>
        <h3 class="text-center text-gray-700 font-bold mb-4">Notez votre anxiété (1-10)</h3>
        <div class="grid grid-cols-2 gap-3 mb-6" id="anxiety-grid"></div>
        <button onclick="app.stopSession()" class="w-full py-4 border-2 border-red-100 text-red-500 bg-red-50 rounded-xl font-bold">Terminer la séance</button>
      </div>

      <div id="screen-post" class="screen no-print">
        <h2 class="text-xl font-bold mb-4">Qu'avez-vous appris ?</h2>
        <p class="text-sm text-gray-500 mb-4 italic">Notez vos observations pour votre thérapeute.</p>
        <textarea id="input-conclusion" placeholder="Ex: J'ai remarqué que personne ne me regardait finalement." class="w-full p-4 border border-gray-300 rounded-xl min-h-[150px] mb-4 focus:ring-2 focus:ring-green-500 outline-none"></textarea>
        <button id="btn-save" onclick="app.saveSession()" disabled class="mt-auto w-full py-4 rounded-xl font-bold text-lg bg-gray-200 text-gray-400 cursor-not-allowed">Valider le bilan</button>
      </div>

      <div id="screen-result" class="screen overflow-y-auto">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold text-gray-800">Bilan d'Exposition</h2>
          <p id="res-date" class="text-gray-400 text-xs"></p>
        </div>
        <div class="mb-4 bg-orange-50 p-4 rounded-xl border border-orange-100">
          <p class="text-[10px] font-bold text-brand-orange uppercase tracking-wider mb-1">Situation</p>
          <p id="res-situation" class="text-gray-800 font-medium leading-tight"></p>
        </div>
        <div class="bg-white p-2 rounded-xl border border-gray-100 h-[280px] mb-6 shadow-sm">
          <canvas id="chartCanvas"></canvas>
        </div>
        <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
          <p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Observation TCC</p>
          <p id="res-conclusion" class="text-gray-700 italic leading-relaxed"></p>
        </div>
        <div class="flex flex-col gap-3 no-print mt-auto">
          <button onclick="window.print()" class="w-full py-4 bg-brand-orange text-white rounded-xl font-bold shadow-lg flex items-center justify-center active:scale-95 transition-transform">
            <i data-lucide="file-text" class="w-5 h-5 mr-2"></i> Partager le Bilan (PDF)
          </button>
          <button onclick="app.reset()" class="w-full py-4 text-gray-400 font-bold">Retour à l'accueil</button>
        </div>
      </div>

      <div id="screen-history" class="screen no-print">
        <div class="flex items-center mb-6">
          <button onclick="app.goToHome()" class="p-2 -ml-2 text-gray-400 hover:text-gray-800 transition-colors"><i data-lucide="arrow-left"></i></button>
          <h2 class="text-xl font-bold ml-2">Historique des séances</h2>
        </div>
        <div id="history-list" class="space-y-3 pb-6"></div>
      </div>

    </div>

    <div id="toast" class="absolute top-6 left-1/2 bg-gray-900 text-white px-6 py-3 rounded-full shadow-xl flex items-center z-50">
      <i data-lucide="check-circle" class="w-4 h-4 mr-2 text-green-400"></i><span class="text-sm font-bold">État enregistré</span>
    </div>
  </main>

  <script>
    const app = {
      state: { elapsed: 0, timerId: null, situation: '', dataPoints: [], pendingMinute: null, history: [] },

      init: function () {
        try {
          const saved = localStorage.getItem('serenetrack_sessions');
          if (saved) app.state.history = JSON.parse(saved);
        } catch (e) {}

        const grid = document.getElementById('anxiety-grid');
        for (let i = 1; i <= 10; i++) {
          const btn = document.createElement('button');
          btn.className = `h-16 rounded-xl font-bold text-xl border-2 transition-all ${app.getBtnColor(i)}`;
          btn.textContent = i;
          btn.onclick = () => app.recordAnxiety(i);
          grid.appendChild(btn);
        }

        document.getElementById('input-situation').oninput = (e) => {
          const b = document.getElementById('btn-start');
          b.disabled = !e.target.value.trim();
          b.className = b.disabled ? 'mt-auto w-full py-4 rounded-xl font-bold text-lg bg-gray-200 text-gray-400' : 'mt-auto w-full py-4 bg-brand-orange text-white rounded-xl font-bold text-lg shadow-lg';
        };

        document.getElementById('input-conclusion').oninput = (e) => {
          const b = document.getElementById('btn-save');
          b.disabled = !e.target.value.trim();
          b.className = b.disabled ? 'mt-auto w-full py-4 rounded-xl font-bold text-lg bg-gray-200 text-gray-400' : 'mt-auto w-full py-4 bg-green-600 text-white rounded-xl font-bold text-lg shadow-lg';
        };

        lucide.createIcons();
      },

      getBtnColor: (l) => l <= 3 ? 'bg-emerald-50 text-emerald-700 border-emerald-200 active:bg-emerald-200' : l <= 6 ? 'bg-amber-50 text-amber-700 border-amber-200 active:bg-amber-200' : 'bg-red-50 text-red-700 border-red-200 active:bg-red-200',

      showScreen: (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        lucide.createIcons();
      },

      // BUG FIX: On vide systématiquement les champs texte pour laisser place aux placeholders
      goToPreSession: () => { 
        document.getElementById('input-situation').value = ''; 
        document.getElementById('input-conclusion').value = ''; 
        app.showScreen('screen-pre'); 
      },
      
      goToHome: () => app.showScreen('screen-home'),

      startSession: function () {
        app.state.situation = document.getElementById('input-situation').value;
        app.state.elapsed = 0; app.state.dataPoints = []; app.state.pendingMinute = 0;
        document.getElementById('lbl-situation').textContent = app.state.situation;
        document.getElementById('status-indicator').className = "h-3 w-3 rounded-full bg-green-500 animate-pulse";
        app.showScreen('screen-running');
        app.updateTimerUI();
        app.updateInputState(true);

        app.state.timerId = setInterval(() => {
          app.state.elapsed++;
          app.updateTimerUI();
          if (app.state.elapsed % 60 === 0) {
            app.state.pendingMinute = app.state.elapsed / 60;
            app.updateInputState(true);
          }
        }, 1000);
      },

      updateTimerUI: () => {
        const m = Math.floor(app.state.elapsed / 60).toString().padStart(2, '0');
        const s = (app.state.elapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer-display').textContent = `${m}:${s}`;
      },

      updateInputState: (active) => {
        document.getElementById('anxiety-grid').className = active ? "grid grid-cols-2 gap-3 mb-6" : "grid grid-cols-2 gap-3 mb-6 opacity-20 pointer-events-none grayscale";
        document.getElementById('prompt-badge').classList.toggle('hidden', !active);
        document.getElementById('wait-text').classList.toggle('hidden', active);
      },

      recordAnxiety: (level) => {
        app.state.dataPoints.push({ minute: app.state.pendingMinute, level });
        app.state.pendingMinute = null;
        app.updateInputState(false);
        const t = document.getElementById('toast');
        t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1500);
      },

      stopSession: () => {
        clearInterval(app.state.timerId);
        document.getElementById('status-indicator').className = "h-3 w-3 rounded-full bg-gray-300";
        app.showScreen('screen-post');
      },

      saveSession: () => {
        const session = {
          id: Date.now(),
          date: new Date().toISOString(),
          situation: app.state.situation,
          duration: app.state.elapsed,
          data: app.state.dataPoints,
          conclusion: document.getElementById('input-conclusion').value
        };
        app.state.history.push(session);
        localStorage.setItem('serenetrack_sessions', JSON.stringify(app.state.history));
        app.renderResult(session);
      },

      renderResult: (session) => {
        document.getElementById('res-date').textContent = new Date(session.date).toLocaleString('fr-FR');
        document.getElementById('res-situation').textContent = session.situation;
        document.getElementById('res-conclusion').textContent = session.conclusion;
        app.showScreen('screen-result');

        const ctx = document.getElementById('chartCanvas').getContext('2d');
        if (window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: session.data.map(d => d.minute),
            datasets: [{
              data: session.data.map(d => d.level),
              borderColor: '#e67e22',
              backgroundColor: 'rgba(230, 126, 34, 0.1)',
              borderWidth: 4,
              fill: true,
              tension: 0.3,
              pointRadius: 4,
              pointBackgroundColor: '#e67e22'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { min: 0, max: 10, ticks: { stepSize: 1 }, title: { display: true, text: 'Anxiété' } },
                x: { title: { display: true, text: 'Temps (min)' } }
            },
            plugins: { legend: { display: false } }
          }
        });
      },

      goToHistory: () => {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        if (app.state.history.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-400 py-10">Aucune séance enregistrée.</div>';
        } else {
            [...app.state.history].reverse().forEach((s, idx) => {
              const date = new Date(s.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
              const el = document.createElement('button');
              el.className = "w-full bg-white border border-gray-100 rounded-2xl p-4 text-left shadow-sm flex justify-between items-center active:bg-gray-50 transition-colors";
              el.onclick = () => app.renderResult(s);
              el.innerHTML = `
                <div class="flex-grow min-w-0 mr-4">
                  <div class="font-bold text-gray-800 truncate">${s.situation}</div>
                  <div class="text-[10px] text-gray-400 mt-1 uppercase font-bold tracking-wider">${date} • ${Math.floor(s.duration / 60)} min</div>
                </div>
                <canvas id="sparkline-${idx}" class="sparkline-canvas"></canvas>
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 ml-2"></i>
              `;
              list.appendChild(el);

              // Dessin Sparkline (Mini-courbe)
              setTimeout(() => {
                const ctx = document.getElementById(`sparkline-${idx}`).getContext('2d');
                const vals = s.data.map(d => d.level);
                new Chart(ctx, {
                  type: 'line',
                  data: { labels: vals, datasets: [{ data: vals, borderColor: '#e67e22', borderWidth: 2, fill: false, pointRadius: 0 }] },
                  options: { 
                    responsive: false, 
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }, 
                    scales: { x: { display: false }, y: { display: false, min: 0, max: 10 } } 
                  }
                });
              }, 0);
            });
        }
        app.showScreen('screen-history');
      },

      reset: () => { 
        app.state.elapsed = 0; 
        document.getElementById('timer-display').textContent = '00:00'; 
        // On vide aussi ici par sécurité
        document.getElementById('input-situation').value = ''; 
        document.getElementById('input-conclusion').value = '';
        app.showScreen('screen-home'); 
      }
    };

    document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>
</html>
